<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
  <meta http-equiv="Content-Style-Type" content="text/css">
  <script src='../bbs.js'></script>

  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-120820034-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag() { dataLayer.push(arguments); }
    gtag('js', new Date());
    gtag('config', 'UA-120820034-1');
  </script>

  <link href="../bbs.css" type="text/css" rel="stylesheet">
  <link rel="shortcut icon" href="favicon.ico">
  <title>Vista UAC機能対応について | サクラエディタ過去ログ</title>
</head>
<body>
<ul class="side">
        <a href="./" class="toindex">◀ANSI版開発トップへ</a>
        <li><div class="list-title">
    <span class="no">4800</span>
    <a class="thread-title" href="4800.html#4800">Vista UAC機能対応について</a></div>
    <ul><li><div class="list-title">
    <span class="no">4801</span>
    <a class="thread-title" href="4800.html#4801">RE: Vista UAC機能対応について</a></div>
    <ul><li><div class="list-title">
    <span class="no">4802</span>
    <a class="thread-title" href="4800.html#4802">Re2: Vista UAC機能対応について</a></div>
    </li><li><div class="list-title">
    <span class="no">4809</span>
    <a class="thread-title" href="4800.html#4809">Re2: Vista UAC機能対応について</a></div>
    <ul><li><div class="list-title">
    <span class="no">4810</span>
    <a class="thread-title" href="4800.html#4810">Re3: Vista UAC機能対応について</a></div>
    </li></ul></li></ul></li><li><div class="list-title">
    <span class="no">4803</span>
    <a class="thread-title" href="4800.html#4803">エディタ本体のUAC対応の必要性</a></div>
    <ul><li><div class="list-title">
    <span class="no">4804</span>
    <a class="thread-title" href="4800.html#4804">UAC&amp;マルチユーザ対応案</a></div>
    <ul><li><div class="list-title">
    <span class="no">4805</span>
    <a class="thread-title" href="4800.html#4805">拡張子連動設定のUAC対応</a></div>
    <ul><li><div class="list-title">
    <span class="no">4811</span>
    <a class="thread-title" href="4800.html#4811">RE: 拡張子連動設定のUAC対応</a></div>
    <ul><li><div class="list-title">
    <span class="no">4812</span>
    <a class="thread-title" href="4800.html#4812">Re2: 拡張子連動設定のUAC対応</a></div>
    </li></ul></li></ul></li><li><div class="list-title">
    <span class="no">4806</span>
    <a class="thread-title" href="4800.html#4806">Re:UAC&amp;マルチユーザ対応案</a></div>
    <ul><li><div class="list-title">
    <span class="no">4808</span>
    <a class="thread-title" href="4800.html#4808">Re2:UAC&amp;マルチユーザ対応案</a></div>
    <ul><li><div class="list-title">
    <span class="no">4823</span>
    <a class="thread-title" href="4800.html#4823">Re3:UAC&amp;マルチユーザ対応案</a></div>
    <ul><li><div class="list-title">
    <span class="no">4824</span>
    <a class="thread-title" href="4800.html#4824">Re4:UAC&amp;マルチユーザ対応案</a></div>
    <ul><li><div class="list-title">
    <span class="no">4826</span>
    <a class="thread-title" href="4800.html#4826">Re5:UAC&amp;マルチユーザ対応案</a></div>
    </li></ul></li></ul></li></ul></li></ul></li><li><div class="list-title">
    <span class="no">4828</span>
    <a class="thread-title" href="4800.html#4828">Re:UAC&amp;マルチユーザ対応案</a></div>
    <ul><li><div class="list-title">
    <span class="no">4829</span>
    <a class="thread-title" href="4800.html#4829">Re2:UAC&amp;マルチユーザ対応案</a></div>
    <ul><li><div class="list-title">
    <span class="no">4830</span>
    <a class="thread-title" href="4800.html#4830">Re3:UAC&amp;マルチユーザ対応案</a></div>
    <ul><li><div class="list-title">
    <span class="no">4831</span>
    <a class="thread-title" href="4800.html#4831">Re4:UAC&amp;マルチユーザ対応案</a></div>
    <ul><li><div class="list-title">
    <span class="no">4832</span>
    <a class="thread-title" href="4800.html#4832">Re5:UAC&amp;マルチユーザ対応案</a></div>
    <ul><li><div class="list-title">
    <span class="no">4833</span>
    <a class="thread-title" href="4800.html#4833">Re6:UAC&amp;マルチユーザ対応案</a></div>
    <ul><li><div class="list-title">
    <span class="no">4834</span>
    <a class="thread-title" href="4800.html#4834">Re7:UAC&amp;マルチユーザ対応案</a></div>
    </li><li><div class="list-title">
    <span class="no">4835</span>
    <a class="thread-title" href="4800.html#4835">Re7:UAC&amp;マルチユーザ対応案</a></div>
    </li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li><li><div class="list-title">
    <span class="no">4836</span>
    <a class="thread-title" href="4800.html#4836">Re:UAC&amp;マルチユーザ対応案</a></div>
    <ul><li><div class="list-title">
    <span class="no">4839</span>
    <a class="thread-title" href="4800.html#4839">Re2:UAC&amp;マルチユーザ対応案</a></div>
    <ul><li><div class="list-title">
    <span class="no">4840</span>
    <a class="thread-title" href="4800.html#4840">Re3:UAC&amp;マルチユーザ対応案</a></div>
    <ul><li><div class="list-title">
    <span class="no">4841</span>
    <a class="thread-title" href="4800.html#4841">Re4:UAC&amp;マルチユーザ対応案</a></div>
    <ul><li><div class="list-title">
    <span class="no">4844</span>
    <a class="thread-title" href="4800.html#4844">Re5:UAC&amp;マルチユーザ対応案</a></div>
    <ul><li><div class="list-title">
    <span class="no">4845</span>
    <a class="thread-title" href="4800.html#4845">Re6:UAC&amp;マルチユーザ対応案</a></div>
    </li></ul></li><li><div class="list-title">
    <span class="no">4856</span>
    <a class="thread-title" href="4800.html#4856">Re5:UAC&amp;マルチユーザ対応案</a></div>
    <ul><li><div class="list-title">
    <span class="no">4857</span>
    <a class="thread-title" href="4800.html#4857">Re6:UAC&amp;マルチユーザ対応案</a></div>
    <ul><li><div class="list-title">
    <span class="no">4861</span>
    <a class="thread-title" href="4800.html#4861">インストーラ作ってみました (Re7:UAC&amp;マルチユーザ対応案)</a></div>
    <ul><li><div class="list-title">
    <span class="no">4862</span>
    <a class="thread-title" href="4800.html#4862">Re:インストーラ作ってみました (Re7:UAC&amp;マルチユーザ対応案)</a></div>
    <ul><li><div class="list-title">
    <span class="no">4863</span>
    <a class="thread-title" href="4800.html#4863">Re2:インストーラ作ってみました (Re7:UAC&amp;マルチユーザ対応案)</a></div>
    <ul><li><div class="list-title">
    <span class="no">4866</span>
    <a class="thread-title" href="4800.html#4866">Re3:インストーラ作ってみました (Re7:UAC&amp;マルチユーザ対応案)</a></div>
    <ul><li><div class="list-title">
    <span class="no">4867</span>
    <a class="thread-title" href="4800.html#4867">Re4:インストーラ作ってみました (Re7:UAC&amp;マルチユーザ対応案)</a></div>
    </li></ul></li></ul></li><li><div class="list-title">
    <span class="no">4864</span>
    <a class="thread-title" href="4800.html#4864">Re2:インストーラ作ってみました (Re7:UAC&amp;マルチユーザ対応案)</a></div>
    </li></ul></li><li><div class="list-title">
    <span class="no">4865</span>
    <a class="thread-title" href="4800.html#4865">設定移行ツール案</a></div>
    </li><li><div class="list-title">
    <span class="no">4868</span>
    <a class="thread-title" href="4800.html#4868">Re:インストーラ作ってみました (Re7:UAC&amp;マルチユーザ対応案)</a></div>
    </li></ul></li></ul></li></ul></li></ul></li></ul></li><li><div class="list-title">
    <span class="no">4846</span>
    <a class="thread-title" href="4800.html#4846">Re3:UAC&amp;マルチユーザ対応案</a></div>
    <ul><li><div class="list-title">
    <span class="no">4850</span>
    <a class="thread-title" href="4800.html#4850">Re4:UAC&amp;マルチユーザ対応案</a></div>
    </li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li>
    </ul><ul class="main"><li><section><h1 id=4800>
    <span class="no">[4800]</span>
    <a class="thread-title" href="#4800">Vista UAC機能対応について</a>
    <span class="author">ryoji</span>
    <time datetime="2007-05-06T00:06:11">2007年05月06日 00:06</time></h1>
    <div class="body">以下、拡張子連動設定(sakuext.exe)の話ですが．．．<br>SakuraDownにも関係するかも（自分は普段は使用してないので動作未確認）。<br>サクラをProgram Files配下にインストールしている場合は何やら複雑なこと<br>になってしまいます。<br><br>&gt;&gt;data:6050の件<br>sakuext.exeに管理者権限実行用のマニフェストを適用すれば、普通の操作で<br>起動した場合でも自動的に「ユーザーアカウント制御」ダイアログが出るよう<br>になり、レジストリ変更が可能です。<br>（現状、普通に実行すると黙って動くがレジストリは変更されない）<br><br>●sakuext.exe.manifestファイルの記述内容<br>---ここから<br>&lt;?xml version="1.0" encoding="UTF-8" standalone="yes"?&gt;<br>&lt;assembly xmlns="urn:schemas-microsoft-com:asm.v1" manifestVersion="1.0"&gt; <br>&lt;assemblyIdentity<br>     version="1.0.0.0"<br>     processorArchitecture="X86"<br>     name="sakuext.exe"<br>     type="win32"<br>/&gt;<br>   &lt;!-- Identify the application security requirements. --&gt;<br>   &lt;trustInfo xmlns="urn:schemas-microsoft-com:asm.v3"&gt;<br>        &lt;security&gt;<br>            &lt;requestedPrivileges&gt;<br>                &lt;requestedExecutionLevel level="requireAdministrator"/&gt;<br>            &lt;/requestedPrivileges&gt;<br>        &lt;/security&gt;<br>   &lt;/trustInfo&gt;<br>&lt;/assembly&gt;<br>---ここまで<br><br>マニフェストは外部ファイルとして提供するのではなく実行ファイルに埋め込ん<br>でしまうほうが良いと思います。<br>が、以下の方法で公式配布されているsakuext.exeに埋め込んでみたところ、<br>「無効なEXEです」で異常終了してしまいました。<br>sakura.exeは同様の方法でできたんですが。。。<br>配布版のsakuext.exeって、ファイル圧縮等の処置が施されてたりしますか？<br><br>●マニフェストの埋め込み方法<br>コマンドラインでmt.exeを実行する（mt.exeは最新のPSDKやVS2005に入っています）。<br><br>コマンド例：<br>mt -manifest sakuext.exe.manifest -hashupdate -outputresource:sakuext.exe;1<br><br>&gt;&gt;data:6051の件(参考：&gt;&gt;data:5925)<br>普通にサクラを使用している場合、VirtualStoreフォルダにiniが作成されます。<br>管理者権限でsakuext.exeを実行すると自フォルダ内のiniを参照しに行きます。<br>どうしましょ？<br></div></section>
    <ul><li><section><h1 id=4801>
    <span class="no">[4801]</span>
    <a class="thread-title" href="#4801">RE: Vista UAC機能対応について</a>
    <span class="author">すい</span>
    <time datetime="2007-05-06T01:00:40">2007年05月06日 01:00</time></h1>
    <div class="body">&gt;マニフェストは外部ファイルとして提供するのではなく実行ファイルに埋め込ん<br>&gt;でしまうほうが良いと思います。<br>&gt;が、以下の方法で公式配布されているsakuext.exeに埋め込んでみたところ、<br>&gt;「無効なEXEです」で異常終了してしまいました。<br>&gt;sakura.exeは同様の方法でできたんですが。。。<br>&gt;配布版のsakuext.exeって、ファイル圧縮等の処置が施されてたりしますか？<br><br>ソースを見て頂けば一目瞭然なのですが、これは HSP で作成してあります。<br>HSP で作成された .EXE はその手の後加工は不可能です。<br><br>マニフェストを埋め込む、ちょっと特殊なコンパイル方法も<br>HSP のヘビーユーザーによって開発されていたように思いましたが、<br>私の手元には確認環境などがありませんし．．．<br></div></section>
    <ul><li><section><h1 id=4802>
    <span class="no">[4802]</span>
    <a class="thread-title" href="#4802">Re2: Vista UAC機能対応について</a>
    <span class="author">ryoji</span>
    <time datetime="2007-05-07T00:09:22">2007年05月07日 00:09</time></h1>
    <div class="body">▼ すいさん<br>&gt; ソースを見て頂けば一目瞭然なのですが、これは HSP で作成してあります。<br>&gt; HSP で作成された .EXE はその手の後加工は不可能です。<br><br>これは確認してませんでした。m(__)m<br><br>補足ですが、埋め込みにしておいたほうが良い理由のひとつに、Vistaでは初回起動時に外部マニフェストが無いと後で追加しても適用されない、というのがあります。<br>外部マニフェストだけでなくEXEのほうを更新しても適用されないので、バージョンアップするだけではたぶん意図したとおりに動いてくれません。<br>※そういう場合にはいったんEXEをXP互換モードで動かせば適用される<br>sakura.exeをビジュアルスタイル化するのも今は外部マニフェストを使っていますが、マニフェストを置いたのにsakura.exeがビジュアルスタイルにならない、といった報告が今後出てくるかもしれません。<br>僕自身、この現象にはちょっと悩まされたので... (^^;</div></section>
    </li><li><section><h1 id=4809>
    <span class="no">[4809]</span>
    <a class="thread-title" href="#4809">Re2: Vista UAC機能対応について</a>
    <span class="author">ryoji</span>
    <time datetime="2007-05-09T22:31:56">2007年05月09日 22:31</time></h1>
    <div class="body">&gt; マニフェストを埋め込む、ちょっと特殊なコンパイル方法も<br>&gt; HSP のヘビーユーザーによって開発されていたように思いましたが、<br>&gt; 私の手元には確認環境などがありませんし．．．<br><br>すいません。ソースはどこにあるんでしょう？<br>（手元にはsakuext.exe, sakuext.txtしかありません）<br>HSPは知らないので手出しできないかもしれませんが。(^^;;;<br><br>sakuextは現行のまま、管理者権限マニフェストを埋め込んだ別exeからsakuextを起動してやる、という手もありそうです。<br>sakura.exeが使用しているiniファイルをexeフォルダにコピーしてからsakuextを起動。<br>こうすれば権限継承で動作し、実フォルダ参照、レジストリ更新とも可能なはず。<br>＃MSのUAC関連資料を見たところ、CreateProcessじゃなくてShellExecuteExを使えば、できそうな感じ。</div></section>
    <ul><li><section><h1 id=4810>
    <span class="no">[4810]</span>
    <a class="thread-title" href="#4810">Re3: Vista UAC機能対応について</a>
    <span class="author">すい</span>
    <time datetime="2007-05-10T00:29:25">2007年05月10日 00:29</time></h1>
    <div class="body">&gt;すいません。ソースはどこにあるんでしょう？<br>&gt;（手元にはsakuext.exe, sakuext.txtしかありません）<br>&gt;HSPは知らないので手出しできないかもしれませんが。(^^;;;<br><br>こちらです。<br><br>http://groups.yahoo.co.jp/group/sakura-editor/files/Junk/<br>└&gt; S-EXT003.CAB<br><br>やっている処理内容自体は大した事ないので、ソースの内容を見て<br>他に移植する、とかなら楽じゃないかと思いますが、<br>HSP でのコンパイル手順方面は面倒かもしれません。(;^o^;) (え゛<br></div></section>
    </li></ul></li></ul></li><li><section><h1 id=4803>
    <span class="no">[4803]</span>
    <a class="thread-title" href="#4803">エディタ本体のUAC対応の必要性</a>
    <span class="author">ryoji</span>
    <time datetime="2007-05-09T00:18:41">2007年05月09日 00:18</time></h1>
    <div class="body">&gt;&gt;data:5905で、「メモ帳や他のエディタでそのファイルを開くと変更が保存されていません。」とありますが、メモ帳は別格としても通常の他エディタでは変更されているように見えるはずなんだけどな？？？<br>まぁ、こういうケースでは利用者にそういうもの（OSの仕様）だと理解してもらうので良いと思いますが、サクラエディタ自身の.ini保存場所について考えてみました。<br><br>もかさんが紹介してくださったURLの記載内容をざっと読んでみたところ、<br><br>・インストーラ／アップデータやシステム設定変更プログラムには管理者権限用のマニフェストを埋め込んでおくこと<br>・一般ユーザ権限で動作させるような通常のアプリはアプリ自身の設定をProgram Files（CSIDL_PROGRAM_FILES）配下のようなコアフォルダに保存してはいけない<br>・Virtual Storeは、いつまでもその存在を当てにはできない（旧式アプリでもエラー回避して実行できるようにするための一時的救済措置であって、64bitアプリ用にはVirtual Storeは提供してない）<br><br>ってことですねぇ～。<br><br>というわけで、.iniがVirtual Store側に保存されるのは回避したほうが良さそうです。<br>64bit化や将来OSでVirtual Storeが無くなったら、保存エラーになって意図どおりに動かなくなっちゃいますから。<br></div></section>
    <ul><li><section><h1 id=4804>
    <span class="no">[4804]</span>
    <a class="thread-title" href="#4804">UAC&amp;マルチユーザ対応案</a>
    <span class="author">ryoji</span>
    <time datetime="2007-05-09T00:22:49">2007年05月09日 00:22</time></h1>
    <div class="body">特に急ぐ必要は無いかもしれませんが、<br>・VistaでのUAC対応<br>・マルチユーザ対応<br>の同時実現案です。<br><br>Ver5.0未満のOS（Win95/98/Me/NT4.0）では従来どおり、常に.exeと同じフォルダに.iniを保存する。<br>Ver5.0以降のOSでもCSIDL_PROGRAM_FILES以外（外部記憶媒体etc.）から起動した場合は、.exeと同じフォルダに.iniを保存する。<br>Ver5.0以降のOSでCSIDL_PROGRAM_FILESから起動した場合のみ以下のように.iniのRead/Writeを機能拡張する。<br><br>【.iniの読出し】<br>(1) ユーザ別設定フォルダ（CSIDL_APPDATA\sakura）に.iniがあればそちらを、無ければ.exeと同じフォルダの.iniを読む。<br><br>※CSIDL_APPDATAの位置<br>2k/XP: C:\Documents and Settings\&lt;username&gt;\Application Data<br>Vista: C:\Users\&lt;username&gt;\AppData\Roaming<br><br>【.iniの保存】<br>(2) Vistaよりも以前のOSでは読み出したときの.iniを更新する（.iniが無い初期起動時は.exeと同じフォルダに.iniを作成）。<br>→ユーザが自分専用の.iniを手動でユーザ別設定フォルダに置くとマルチユーザ対応になる<br>(3) Vista以後のOSでは常にユーザ別設定フォルダに.ini保存する。<br>→自動的にマルチユーザ対応＆Virtual Storeへの.ini保存を回避<br><br>【従来仕様から新仕様へのバージョンアップ時動作】<br>Vista以外の利用者は(1)(2)により、手動でマルチユーザ化を行わない限り従来と何も変わりません。<br>既にVista移行しているユーザの場合、バージョンアップ時、<br>・(1)で、.exeと同じフォルダの.iniを読もうとしてVirtual Storeから最新の.iniが読まれる<br>・(3)で、更新後の.iniがユーザ別設定フォルダに保存される<br>・以後、ユーザ別設定フォルダの.iniが使われる<br>ということになります。<br><br>その他、マルチユーザ動作する場合（.iniの保存先がユーザ別設定フォルダになる場合）には、次のようにするのが良いかも。<br>・.iniだけでなく、ユーザ指定アイコン、マクロ等の相対位置の基準もユーザ別設定フォルダにする<br>・各種設定のimport/export時など、ファイルダイアログを表示する際の初期表示はCSIDL_MYDOCUMENTSにする<br>（CSIDL_PROGRAM_FILESへの保存を促すようなことは避ける）<br>あと、ついでに簡易ユーザ切替え対応も。<br><br>CSIDL_PROGRAM_FILES配下の.exeフォルダとユーザ別設定フォルダをまとめてひとつのフォルダに放り込めば、持ち歩き用外部記憶媒体の出来上がり（これもツール化すればもっと楽になると思います）。<br><br>この案だと、CSIDL_PROGRAM_FILES以外のコアフォルダ（CSIDL_WINDOWSなど）から実行した場合に.iniがVirtual Store側に保存されることについては面倒を見ない、ということにはなりますが．．．<br>あと、シングルユーザ／マルチユーザを設定で切り替える、というのもちらっと考えたんですが、その設定自体を保存する場所が無いということに。(^^;</div></section>
    <ul><li><section><h1 id=4805>
    <span class="no">[4805]</span>
    <a class="thread-title" href="#4805">拡張子連動設定のUAC対応</a>
    <span class="author">ryoji</span>
    <time datetime="2007-05-09T00:29:55">2007年05月09日 00:29</time></h1>
    <div class="body">&gt; ・VistaでのUAC対応<br>&gt; ・マルチユーザ対応<br>&gt; の同時実現案です。<br><br>の案が前提ですが、拡張子連動設定のほうは管理者権限用マニフェストを適用するのに加えて、.iniの場所をエディタ本体から教えてもらうインターフェースを用意するのが良いのでしょうね。<br>具体的なところまでは考えてませんが、環境変数を使うとか？</div></section>
    <ul><li><section><h1 id=4811>
    <span class="no">[4811]</span>
    <a class="thread-title" href="#4811">RE: 拡張子連動設定のUAC対応</a>
    <span class="author">すい</span>
    <time datetime="2007-05-10T00:40:01">2007年05月10日 00:40</time></h1>
    <div class="body">&gt;の案が前提ですが、拡張子連動設定のほうは管理者権限用マニフェストを適用するのに加えて、.iniの場所をエディタ本体から教えてもらうインターフェースを用意するのが良いのでしょうね。<br>&gt;具体的なところまでは考えてませんが、環境変数を使うとか？<br><br>別案<br>サクラエディタ内部に設定画面を設けて、そこから操作する。<br><br>案１.関連付けツールの関連付け処理部をサクラエディタ内部に移植する。<br><br>案２.サクラエディタから関連付けツールに対して、関連付け処理を依頼する。<br>　　 例えば、サクラエディタに設けた設定画面で「.txt に関連付けしろ」と<br>　　 操作されたら、サクラエディタが sakuext.exe に対して<br>　　 「.txt に sakura.exe を関連付けしろ」という指示を出して処理させる。<br><br>こういう方法なら、そもそも .ini の位置は気にしなくて良くなります。<br></div></section>
    <ul><li><section><h1 id=4812>
    <span class="no">[4812]</span>
    <a class="thread-title" href="#4812">Re2: 拡張子連動設定のUAC対応</a>
    <span class="author">ryoji</span>
    <time datetime="2007-05-10T01:54:02">2007年05月10日 01:54</time></h1>
    <div class="body">▼ すいさん<br>利便性も考慮するとすいさんの案が良さそうですね。念のため事前にレジストリ変更の確認メッセージも出すようにすれば問題無いかな？<br>ただ、UAC配下では、<br>・管理権限exeは起動するたびに実行確認のUACダイアログが出る<br>・一般権限exeは管理権限には昇格できない<br>ようなので、案１は採用できそうにないですけど、案２なら。</div></section>
    </li></ul></li></ul></li><li><section><h1 id=4806>
    <span class="no">[4806]</span>
    <a class="thread-title" href="#4806">Re:UAC&amp;マルチユーザ対応案</a>
    <span class="author">ryoji</span>
    <time datetime="2007-05-09T01:13:40">2007年05月09日 01:13</time></h1>
    <div class="body">忘れないうちに．．．<br>&gt; その他、<br>ファイル名簡易表示に"%AppData%"を追加。</div></section>
    <ul><li><section><h1 id=4808>
    <span class="no">[4808]</span>
    <a class="thread-title" href="#4808">Re2:UAC&amp;マルチユーザ対応案</a>
    <span class="author">maru</span>
    <time datetime="2007-05-09T21:08:14">2007年05月09日 21:08</time></h1>
    <div class="body">&gt;・.iniだけでなく、ユーザ指定アイコン、マクロ等の相対位置の基準もユーザ別設定フォルダにする<br>キーワードヘルプファイルやアウトラインルールファイルの相対位置も同様なんですよね。<br>あと、どこのiniファイルで動作しているのか確認する機能が必要かどうか。debugビルド専用の機能で良いのかも。<br></div></section>
    <ul><li><section><h1 id=4823>
    <span class="no">[4823]</span>
    <a class="thread-title" href="#4823">Re3:UAC&amp;マルチユーザ対応案</a>
    <span class="author">ryoji</span>
    <time datetime="2007-05-16T01:02:06">2007年05月16日 01:02</time></h1>
    <div class="body">▼ maruさん<br>&gt; あと、どこのiniファイルで動作しているのか確認する機能が必要かどうか。debugビルド専用の機能で良いのかも。<br>よく考えてみるとS_ExpandParameterで取得可能にする必要がありそうですね。<br>エディタのフルパスを取得しているような既存マクロの中には、そちらに要変更なものもありそうです。<br>言われてみなければ気がつかない所でした。ありがとうございます。<br>＃パッチ提出に向けてぼちぼち作業中</div></section>
    <ul><li><section><h1 id=4824>
    <span class="no">[4824]</span>
    <a class="thread-title" href="#4824">Re4:UAC&amp;マルチユーザ対応案</a>
    <span class="author">maru</span>
    <time datetime="2007-05-16T01:46:17">2007年05月16日 01:46</time></h1>
    <div class="body">&gt;&gt; あと、どこのiniファイルで動作しているのか確認する機能が必要かどうか。debugビルド専用の機能で良いのかも。<br>&gt;よく考えてみるとS_ExpandParameterで取得可能にする必要がありそうですね。<br>&gt;エディタのフルパスを取得しているような既存マクロの中には、そちらに要変更なものもありそうです。<br>そういえばユーザiniがあるとき、デバッグ用のexeもやはりユーザiniを参照することになる？<br>とすると、通常のexeとデバッグのexeでユーザiniの奪い合いになり、ややこしいですね。どうしたらいいのだろう。<br></div></section>
    <ul><li><section><h1 id=4826>
    <span class="no">[4826]</span>
    <a class="thread-title" href="#4826">Re5:UAC&amp;マルチユーザ対応案</a>
    <span class="author">ryoji</span>
    <time datetime="2007-05-16T21:39:24">2007年05月16日 21:39</time></h1>
    <div class="body">▼ maruさん<br>&gt; そういえばユーザiniがあるとき、デバッグ用のexeもやはりユーザiniを参照することになる？<br>&gt; とすると、通常のexeとデバッグのexeでユーザiniの奪い合いになり、ややこしいですね。どうしたらいいのだろう。<br>この部分はもう先行実装していて、今のところProgram Filesのサブフォルダパスをそのままユーザ設定フォルダに展開するようにしてます。<br>つまり、<br>C:\Program Files\sakura\sakura.exe<br>C:\Program Files\sakura\Release\sakura.exe<br>C:\Program Files\sakura\Debug\sakura.exe<br>があったとすると、それぞれが使うiniファイルは、<br>C:\Users\&lt;user&gt;\AppData\Roaming\sakura\sakura.ini<br>C:\Users\&lt;user&gt;\AppData\Roaming\sakura\Release\sakura.ini<br>C:\Users\&lt;user&gt;\AppData\Roaming\sakura\Debug\sakura.ini<br>のように別々になるようにしています。<br>こういうので良いかしら？<br>＃こんなところにも、Program Files以外は面倒見ない目論見が現れていたりします。(^^;</div></section>
    </li></ul></li></ul></li></ul></li></ul></li><li><section><h1 id=4828>
    <span class="no">[4828]</span>
    <a class="thread-title" href="#4828">Re:UAC&amp;マルチユーザ対応案</a>
    <span class="author">ryoji</span>
    <time datetime="2007-05-19T02:32:06">2007年05月19日 02:32</time></h1>
    <div class="body">sakuext.exe側のUAC対策（ベース案は&gt;&gt;dev:4809）<br>および、<br>sakura.exe側のUAC &amp; マルチユーザ対応<br>のパッチを作成しました。<br>→Patches#1721425</div></section>
    <ul><li><section><h1 id=4829>
    <span class="no">[4829]</span>
    <a class="thread-title" href="#4829">Re2:UAC&amp;マルチユーザ対応案</a>
    <span class="author">げんた</span>
    <time datetime="2007-05-19T23:27:56">2007年05月19日 23:27</time></h1>
    <div class="body">iniファイルの選択だけ動作確認いたしました．<br><br>設定ファイルの名前＝実行ファイル名.ini<br>実行ファイル名を変更すると設定ファイル名も変わる．<br>(従来からこういう動作だったのですね)<br><br>Program Filesに入っていない場合は常に実行ファイルと同じディレクトリで設定ファイルが読み書きされる．<br><br>Program Filesに入っている場合には...<br>[Windows XP]<br>自分でApplication Data\[Program Filesのインストールディレクトリ名]\[実行ファイル名].ini<br>を作成すればそれが使われる．それがなければ実行ファイルと同じディレクトリ．(いずれも読み書きとも．)<br><br>[Windows Vista]<br>実行ファイルと同一ディレクトリ(Virtual Store含む)に設定ファイルがあればそれが読み込まれる．<br>保存は常にユーザ\AppData\Roaming\[Program Filesのインストールディレクトリ名]\[実行ファイル名].ini<br><br>-----<br>で，本題．<br>キーワードヘルプ等で相対パスの読み出し基準パスがIniファイルベースに変更されていますが，例えば既にVistaへインストールを行ってProgram Files\sakuraにファイルを(管理者権限で)置いている場合，新バージョンを使うと自分でファイルをiniの場所へ移動しないと見えなくなりませんか？<br><br>相対パスでファイル(ini以外)を開くときは常に個人ディレクトリ→無ければ実行ファイルの場所と両方チェックするようにすべきではないのかなと思います．<br><br>それともう一つ．AppDataは隠しファイルなのでエクスプローラの設定を変えないと見えませんよね．<br>そこへ各種ファイルを自分でコピーするのは誰でもできるとは言い難い感じがします．<br>Program Filesへ入れるときはインストーラを使うでしょうから，インストーラで設定ファイルのディレクトリを開くショートカットを作るのも1つの方法かもしれません．<br></div></section>
    <ul><li><section><h1 id=4830>
    <span class="no">[4830]</span>
    <a class="thread-title" href="#4830">Re3:UAC&amp;マルチユーザ対応案</a>
    <span class="author">ryoji</span>
    <time datetime="2007-05-20T22:12:52">2007年05月20日 22:12</time></h1>
    <div class="body">▼ げんたさん<br>&gt; 相対パスでファイル(ini以外)を開くときは常に個人ディレクトリ→無ければ実行ファイルの場所と両方チェックするようにすべきではないのかなと思います．<br>両方チェックするようにしてみました。<br><br>&gt; それともう一つ．AppDataは隠しファイルなのでエクスプローラの設定を変えないと見えませんよね．<br>&gt; そこへ各種ファイルを自分でコピーするのは誰でもできるとは言い難い感じがします．<br>&gt; Program Filesへ入れるときはインストーラを使うでしょうから，インストーラで設定ファイルのディレクトリを開くショートカットを作るのも1つの方法かもしれません．<br>こちらはあまり良い案が思い浮かびません。<br>隠しフォルダかどうかには関係なく、相対指定時にexeファイル位置以外が基準になるということ自体ユーザーにはわかりにくいと思います。<br>というか、自分は最近まで相対指定できることも知らなかったのでフォルダ／ファイルはすべて絶対指定していました。(^^;<br><br>＃iniのファイル名がexeのファイル名と同じになるのは<br>＃知ってて使ってましたが．．．<br>＃皆さん、こういうのって、ご存じなのでしょうか？</div></section>
    <ul><li><section><h1 id=4831>
    <span class="no">[4831]</span>
    <a class="thread-title" href="#4831">Re4:UAC&amp;マルチユーザ対応案</a>
    <span class="author">すい</span>
    <time datetime="2007-05-21T00:26:21">2007年05月21日 00:26</time></h1>
    <div class="body">相対パスでファイル(ini以外) を指定するというのは、<br>サクラエディタのセット一式をフロッピーディスクや<br>USBメモリー等、リムーバブルメディアに入れて持ち運ぶため、<br>というのがそもそもの存在理由なのであって、、、<br><br># 私は「パソコンによってインストール先ドライブが異なるけど<br># 設定はそのままコピーできるようにしたい」という理由で使って<br># ますけど。<br># 1. パソコンA にて、各種項目を使いやすくなるよう設定<br># 2. そのまま↑を他のパソコンB,パソコンC,... にゴッソリ コピーして設定完了。<br># 　 パソコンによって A: とか C: とか H: とか<br><br>ですから相対パス指定時は sakura.exe のパス以外を<br>参照されるようだと困ると思うのですが。<br><br>sakura.exe 基準に探してファイルが無い場合、一応、<br>他も見てみる、というなら許容されるかもしれませんが。<br></div></section>
    <ul><li><section><h1 id=4832>
    <span class="no">[4832]</span>
    <a class="thread-title" href="#4832">Re5:UAC&amp;マルチユーザ対応案</a>
    <span class="author">ryoji</span>
    <time datetime="2007-05-21T01:25:45">2007年05月21日 01:25</time></h1>
    <div class="body">▼ すいさん<br>&gt; # 私は「パソコンによってインストール先ドライブが異なるけど<br>&gt; # 設定はそのままコピーできるようにしたい」という理由で使って<br>&gt; # ますけど。<br>VistaでProgram Files下に置く場合は、そういう利用方法自体ができなくなるんですよね～。<br>Program Files下のファイル（辞書やマクロ）をエディタで編集すると実体はVirtual Store行きなので、そのPC上ではあたかも保存されたように意図通りの動作をするけど、sakuraフォルダをまるごと別PCにコピーしても編集後ファイルはコピーされないです。<br>＃エクスプローラでProgram Files下を扱う場合はVirtual Storeは参照されない<br>WSHで書かれたマクロファイルあたりだと、これがまた特殊で、ファイルを開く時点で書き込みオープンできなかったりします。<br><br>それで、Program Files下以外なら従来と同じ動作になるよう、exeとiniを同一フォルダで扱うように考えているわけでして、<br>従来感覚でフォルダをひとつだけ丸ごとコピーするのみで移行できるようにしておきたい、ということになると非保護の別フォルダにインストールして使用するしか無いんじゃないか？と思います。</div></section>
    <ul><li><section><h1 id=4833>
    <span class="no">[4833]</span>
    <a class="thread-title" href="#4833">Re6:UAC&amp;マルチユーザ対応案</a>
    <span class="author">ラスティブ</span>
    <time datetime="2007-05-21T15:35:10">2007年05月21日 15:35</time></h1>
    <div class="body">話はそれるかも知れませんけれども、<br>従来感覚は損なわれるけどエディタ本体とそれに付随する<br>ユーザー設定ファイルの移動を<br>円滑に行うための機能を提供できたりは、しませんか？<br>「サクラダウン」のような専用ツールを用意するとか… ^^;<br><br>Program Files には容易に触れられなくなるようですし。<br></div></section>
    <ul><li><section><h1 id=4834>
    <span class="no">[4834]</span>
    <a class="thread-title" href="#4834">Re7:UAC&amp;マルチユーザ対応案</a>
    <span class="author">maru</span>
    <time datetime="2007-05-22T00:40:29">2007年05月22日 00:40</time></h1>
    <div class="body">&gt;「サクラダウン」のような専用ツールを用意するとか… ^^;<br>あれはオモチャです(^^;;<br>正直こんなにユーザが増えると思ってなかったので…。<br></div></section>
    </li><li><section><h1 id=4835>
    <span class="no">[4835]</span>
    <a class="thread-title" href="#4835">Re7:UAC&amp;マルチユーザ対応案</a>
    <span class="author">ryoji</span>
    <time datetime="2007-05-22T01:25:18">2007年05月22日 01:25</time></h1>
    <div class="body">▼ ラスティブさん<br>&gt; 従来感覚は損なわれるけどエディタ本体とそれに付随する<br>&gt; ユーザー設定ファイルの移動を<br>&gt; 円滑に行うための機能を提供できたりは、しませんか？<br>&gt; 「サクラダウン」のような専用ツールを用意するとか… ^^;<br>ご意見ありがとうございます。<br>それも一案ですね～。<br><br>とはいえ、それ以前に本体としてできる限りのことはしておきたいので、そのあたりはしっかり詰めておきたいところです。</div></section>
    </li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li><li><section><h1 id=4836>
    <span class="no">[4836]</span>
    <a class="thread-title" href="#4836">Re:UAC&amp;マルチユーザ対応案</a>
    <span class="author">ryoji</span>
    <time datetime="2007-05-22T02:04:20">2007年05月22日 02:04</time></h1>
    <div class="body">&gt; 【.iniの読出し】<br>&gt; (1) ユーザ別設定フォルダ（CSIDL_APPDATA\sakura）に.iniがあればそちらを、無ければ.exeと同じフォルダの.iniを読む。<br>&gt; <br>&gt; ※CSIDL_APPDATAの位置<br>&gt; 2k/XP: C:\Documents and Settings\&lt;username&gt;\Application Data<br>&gt; Vista: C:\Users\&lt;username&gt;\AppData\Roaming<br><br>CSIDL_APPDATAではなくCSIDL_PROFILE\.sakura\としてみたらどうだろう？<br>C:\Program Files\sakura\<br>　↓<br>2k/XP: C:\Documents and Settings\&lt;username&gt;\.sakura\sakura\<br>Vista: C:\Users\&lt;username&gt;\.sakura\sakura<br><br>VistaだとC:\Users\&lt;username&gt;\が従来のマイドキュメント並の扱いになっていて、ここに入れると結構目立ちます。<br>マイドキュメント並の扱い、というのは、スタートメニュー、デスクトップ、ファイルダイアログのプレースバーにショートカットがあるという意味です。<br>（マイドキュメントはC:\Users\&lt;username&gt;\のサブフォルダに格下げされている）<br>jEditなんかはここに.jeditサブフォルダを作成して使っているようです。<br>CSIDL_APPDATAのような隠しフォルダ下に置くのとは随分印象が違ってくるような。<br>マクロや辞書はアクセスしやすい場所に置きたいですからね。<br><br>&gt;その他<br>&gt;&gt;data:5905 にも対処できそうです。<br>&gt;&gt;dev:4800 のマニフェストをsakura.exe用にちょっといじるだけ（管理権限実行ではなくユーザ権限実行されるように書き換える）。<br>Virtual Storeは動作が紛らわしく、ユーザーを混乱させるだけなので、保護フォルダ下への保存は素直にエラーになってくれたほうがいい。<br>というか、Virtual Storeは旧アプリ用に用意されてるだけなんだから、Vista対応アプリではマニフェスト使うのが筋なのでしょうね。<br>上記マニフェスト適用で、ファイル保存時に次のようなエラーメッセージが出てくれるのを確認しました。<br><br>-----------------------<br>「[Window Title]<br>名前を付けて保存<br><br>[Content]<br>C:\Program Files\sakura\無題<br>この場所に保存するアクセス許可がありません。<br>管理者に連絡してアクセス許可を取得してください。<br><br>代わりに [&lt;username&gt;] フォルダに保存しますか?<br><br>[はい(Y)] [いいえ(N)]<br>-----------------------<br><br>[はい(Y)] を選ぶと、C:\Users\&lt;username&gt;フォルダ表示に。<br>いい感じ！</div></section>
    <ul><li><section><h1 id=4839>
    <span class="no">[4839]</span>
    <a class="thread-title" href="#4839">Re2:UAC&amp;マルチユーザ対応案</a>
    <span class="author">げんた</span>
    <time datetime="2007-05-23T00:04:43">2007年05月23日 00:04</time></h1>
    <div class="body">&gt;CSIDL_APPDATAではなくCSIDL_PROFILE\.sakura\としてみたらどうだろう？<br>&gt;VistaだとC:\Users\&lt;username&gt;\が従来のマイドキュメント並の扱いになっていて、ここに入れると結構目立ちます。<br>いいかもしれませんね．XP以前では別にそれを使うのは必須ではないし，APPDATAでもProfile直下でも大差はないと思いますので．<br><br>Vistaに詳しい方へ質問(^^)<br>* ドットで始める意味は？隠しフォルダになるんですか？<br>* Windows標準の(例えばダウンロード)フォルダのようにフォルダ名とユーザに見せる名前を変えることってできるんでしょうか？<br><br>&gt;上記マニフェスト適用<br>kwsk..あ，いや，Vista初心者のために具体的に説明していただけるとありがたいです．<br><br>&gt;プレースバー<br>余談ですが，先日PCショップに展示してあるMacを見て，プレースバーがあまりにVistaに似ていたので(というかVistaのバーがあまりにMacに似ていたので)驚きました．<br></div></section>
    <ul><li><section><h1 id=4840>
    <span class="no">[4840]</span>
    <a class="thread-title" href="#4840">Re3:UAC&amp;マルチユーザ対応案</a>
    <span class="author">ryoji</span>
    <time datetime="2007-05-23T01:22:41">2007年05月23日 01:22</time></h1>
    <div class="body">▼ げんたさん<br>&gt; * ドットで始める意味は？隠しフォルダになるんですか？<br>通常、システム予約のようなファイル／フォルダにつけるんじゃないでしょうか？<br>ユーザ自身が決めたのではない、OSや個々のソフトが定めた目的のものにつけられる名称、かな。<br>隠しフォルダにはならないみたいです。<br>Windowsではあまり多くは見かけないですね。（UNIX系の文化？）<br>エクスプローラでドットから始まるファイル名／フォルダ名は作れず、リネームもできないみたいです。<br>コマンドプロンプトからは mkdir ".sakura" のようにして作れます。<br><br>&gt; * Windows標準の(例えばダウンロード)フォルダのようにフォルダ名とユーザに見せる名前を変えることってできるんでしょうか？<br>これは、知らないです～。（調べたこともない）<br><br>&gt; &gt;上記マニフェスト適用<br>&gt; kwsk..あ，いや，Vista初心者のために具体的に説明していただけるとありがたいです．<br>何に関する説明をすればいいのかよくわからないですが．．．<br>"requireAdministrator"の部分を"asInvoker"にします。<br>マニフェストが無い、あるいはマニフェストにtrustInfoセクションが無いアプリは、Program Files配下に設定ファイルを持つ旧式アプリの可能性があり、そこに書き込めないとまったく使い物にならないかもしれない、ということでVirtual Storeを使わされるのだと思います。<br>もうメンテもされていないようなアプリなら、それでいいんでしょうけど。。。<br>ちなみに、Vistaではタスクマネージャの[プロセス]タブのリストビューに「仮想化」という列を表示することができます。<br>どうやら、Virtual Storeが適用されているプロセスはここが「有効」と表示されるようです。</div></section>
    <ul><li><section><h1 id=4841>
    <span class="no">[4841]</span>
    <a class="thread-title" href="#4841">Re4:UAC&amp;マルチユーザ対応案</a>
    <span class="author">げんた</span>
    <time datetime="2007-05-23T06:37:19">2007年05月23日 06:37</time></h1>
    <div class="body">&gt;&gt; * ドットで始める意味は？隠しフォルダになるんですか？<br>&gt;エクスプローラでドットから始まるファイル名／フォルダ名は作れず、リネームもできないみたいです。<br>あ，なるほど．これは意味があるかも．名前を勝手に変えられると認識されなくなりますからね．<br><br>&gt;&gt; * Windows標準の(例えばダウンロード)フォルダのようにフォルダ名とユーザに見せる名前を変えることってできるんでしょうか？<br>&gt;これは、知らないです～。（調べたこともない）<br>「Sakura設定ファイル」とか見せられると.sakuraよりは見栄えがよいかなと思ったのです．<br>できたとしてもレジストリ設定が必要になりそうな予感はしますね．<br><br>&gt;"requireAdministrator"の部分を"asInvoker"にします。<br>&gt;マニフェストが無い、あるいはマニフェストにtrustInfoセクションが無いアプリは、Program Files配下に設定ファイルを持つ旧式アプリの可能性があり、そこに書き込めないとまったく使い物にならないかもしれない、ということでVirtual Storeを使わされるのだと思います。<br>なるほど．明示的にユーザ権限で実行される場合はVirtual Store機能は無効になるのですね．<br><br>ちなみにこの場合，例えばシステムファイルを編集するつもりで意図的に「管理者で実行」を選んでも，Vistaの場合はProgram Filesには書き込まないようにしてあるから実行権限には関係なくユーザの設定が使われるという理解で良いのでしょうか．<br>現状ではManifestが無いから管理者として実行するとProgram Filesに書き込めてしまってVirtual Storeのファイルと矛盾する結果になるのかな？<br></div></section>
    <ul><li><section><h1 id=4844>
    <span class="no">[4844]</span>
    <a class="thread-title" href="#4844">Re5:UAC&amp;マルチユーザ対応案</a>
    <span class="author">ryoji</span>
    <time datetime="2007-05-23T22:26:17">2007年05月23日 22:26</time></h1>
    <div class="body">▼ げんたさん<br>&gt; ちなみにこの場合，例えばシステムファイルを編集するつもりで意図的に「管理者で実行」を選んでも，Vistaの場合はProgram Filesには書き込まないようにしてあるから実行権限には関係なくユーザの設定が使われるという理解で良いのでしょうか．<br>"asInvoker"アプリをユーザが明示的に「管理者で実行」すれば、"requireAdministrator"アプリと同じ動きになります。<br>UAC的に保護されているだけのファイルであれば実ファイルへの書き込み可能です。<br>（システムdllなどは別の保護が働くから管理者でも直接は上書きできない）<br><br>&gt; 現状ではManifestが無いから管理者として実行するとProgram Filesに書き込めてしまってVirtual Storeのファイルと矛盾する結果になるのかな？<br>そうです。仮想化されているアプリとされていないアプリとでは見えるものが違ってしまいます。<br>エクスプローラやメモ帳は仮想化されておらず、それらと見えるものが違うという現状は気持ち悪い(^^;です。<br>新規保存したはずなのにエクスプローラで見えない、とか。（そういうときは「互換性ファイル」ボタンを押せば実フォルダから仮想フォルダへ移動して見ることはできる）</div></section>
    <ul><li><section><h1 id=4845>
    <span class="no">[4845]</span>
    <a class="thread-title" href="#4845">Re6:UAC&amp;マルチユーザ対応案</a>
    <span class="author">ryoji</span>
    <time datetime="2007-05-23T22:40:15">2007年05月23日 22:40</time></h1>
    <div class="body">▼ げんたさん<br>&gt; &gt; 現状ではManifestが無いから管理者として実行するとProgram Filesに書き込めてしまってVirtual Storeのファイルと矛盾する結果になるのかな？<br>そういえば、現状のインストーラでは最後の画面でエディタ起動できるんですが、このときはインストーラの管理者権限を継承しているので仮想化無しで動作し、UAC保護されている実フォルダへの書き込みができますし、iniファイルも実フォルダに書き込まれます。(^^;</div></section>
    </li></ul></li><li><section><h1 id=4856>
    <span class="no">[4856]</span>
    <a class="thread-title" href="#4856">Re5:UAC&amp;マルチユーザ対応案</a>
    <span class="author">げんた</span>
    <time datetime="2007-05-31T02:10:36">2007年05月31日 02:10</time></h1>
    <div class="body">&gt; &gt;"requireAdministrator"の部分を"asInvoker"にします。<br>&gt; &gt;マニフェストが無い、あるいはマニフェストにtrustInfoセクションが無いアプリは、Program Files配下に設定ファイルを持つ旧式アプリの可能性があり、そこに書き込めないとまったく使い物にならないかもしれない、ということでVirtual Storeを使わされるのだと思います。<br>&gt; なるほど．明示的にユーザ権限で実行される場合はVirtual Store機能は無効になるのですね．<br>で，ふと気になったことが．<br><br>Virtual Storeを使わない<br>＝既にVirtual Storeに入れたファイルは読み出せない<br>＝sakuraをバージョンアップしたら設定が初期化される！<br><br>となります？さすがにこれはまずいかと．<br></div></section>
    <ul><li><section><h1 id=4857>
    <span class="no">[4857]</span>
    <a class="thread-title" href="#4857">Re6:UAC&amp;マルチユーザ対応案</a>
    <span class="author">ryoji</span>
    <time datetime="2007-05-31T22:34:01">2007年05月31日 22:34</time></h1>
    <div class="body">▼ げんたさん<br>&gt; &gt; &gt;"requireAdministrator"の部分を"asInvoker"にします。<br>&gt; &gt; &gt;マニフェストが無い、あるいはマニフェストにtrustInfoセクションが無いアプリは、Program Files配下に設定ファイルを持つ旧式アプリの可能性があり、そこに書き込めないとまったく使い物にならないかもしれない、ということでVirtual Storeを使わされるのだと思います。<br>&gt; &gt; なるほど．明示的にユーザ権限で実行される場合はVirtual Store機能は無効になるのですね．<br>&gt; で，ふと気になったことが．<br>&gt; <br>&gt; Virtual Storeを使わない<br>&gt; ＝既にVirtual Storeに入れたファイルは読み出せない<br>&gt; ＝sakuraをバージョンアップしたら設定が初期化される！<br>&gt; <br>&gt; となります？さすがにこれはまずいかと．<br><br>OSの違いには自動的に対応するのが良いかと思いましたが、難しそうですね。<br>UACも当初のONからOFFに切り替えて使っているという場合もあるでしょうし、どれが最新の現用ファイルかはユーザ自身にしかわからないですね。<br><br>・Program Filesに置いた場合だけマルチユーザ化の対象にする<br>・設定を自動移行する<br>・マニフェストを埋め込みにする<br>↑は全部やめて、<br><br>↓にしようと思います。<br>・sakura.exeと同じフォルダにある特別なファイルでマルチユーザ設定してもらう（UAC対象のProgram Files下の場合は他フォルダで編集後コピーするとか、管理者指定でエディタ起動して編集するとか）<br>・上記ファイルの指定に従って、設定ファイルは手動で移動してもらう（現用ファイルの判断は本人任せ）<br>・Virtual Storeを使わないようにするときはそれ用の外部マニフェストを適用してもらう<br>デフォルトは従来と何一つ変えず、意図的に変更する場合のみ、すべて手動でやってもらう、と。<br>面倒といえば面倒ですが、自分に最適な環境の再構築は自分でやってもらうことに。<br>エディタ本体には、環境変更時にしか利用されない冗長な機能は付けない。（やるとすれば別ツールで）</div></section>
    <ul><li><section><h1 id=4861>
    <span class="no">[4861]</span>
    <a class="thread-title" href="#4861">インストーラ作ってみました (Re7:UAC&amp;マルチユーザ対応案)</a>
    <span class="author">げんた</span>
    <time datetime="2007-06-04T03:27:34">2007年06月04日 03:27</time></h1>
    <div class="body">&gt;・Virtual Storeを使わないようにするときはそれ用の外部マニフェストを適用してもらう<br>Virtual StoreをOFFにすると既にインストールして使っている人がバージョンアップした場合に設定が全て消えたように見えるという問題を考えると無条件でマニフェストの入れ替えを行うわけにはいかず，かといって&gt;&gt;data:5905を考慮するとVirutalStoreは無効であることがが望ましい．<br><br>移行ツールをつくるにも，インストーラがAdministratorで動いているとVirtualStoreが見えないという問題があります．Admin権限のままVitualStoreの場所を取得する方法がわかれば移行ツールを実行して対処できるのですが...<br><br>とりあえずryojiさんのMultiUser2.patchを使ってマルチユーザ対応インストーラを作ってみました．<br>http://sakura.qp.land.to/dev/?Installer<br><br>Administrator権限が無くてもそれなりにインストールできるようにしてみました．<br></div></section>
    <ul><li><section><h1 id=4862>
    <span class="no">[4862]</span>
    <a class="thread-title" href="#4862">Re:インストーラ作ってみました (Re7:UAC&amp;マルチユーザ対応案)</a>
    <span class="author">ryoji</span>
    <time datetime="2007-06-04T21:51:01">2007年06月04日 21:51</time></h1>
    <div class="body">▼ げんたさん<br>&gt; &gt;・Virtual Storeを使わないようにするときはそれ用の外部マニフェストを適用してもらう<br>&gt; Virtual StoreをOFFにすると既にインストールして使っている人がバージョンアップした場合に設定が全て消えたように見えるという問題を考えると無条件でマニフェストの入れ替えを行うわけにはいかず，かといって&gt;&gt;data:5905を考慮するとVirutalStoreは無効であることがが望ましい．<br>インストール先に既存のsakura.exeがある場合は既存環境を引き継ぐだけで良いのではないでしょうか。<br><br>新規セットアップでは<br>・OSに関係なくVirtual Store OFF用のsakura.exe.manifestを入れる<br>・マルチユーザ選択画面に合わせたsakura.exe.iniを入れる<br><br>上書きセットアップでは<br>・Virtual Store OFF用のsakura.exe.manifestを別の名前で入れる（サンプル）<br>・マルチユーザ選択画面は出さずにsakura.exe.iniを別の名前で入れる（サンプル）<br><br>既にsakura.exe.iniがあるなら再選択は邪魔なだけだと思います。</div></section>
    <ul><li><section><h1 id=4863>
    <span class="no">[4863]</span>
    <a class="thread-title" href="#4863">Re2:インストーラ作ってみました (Re7:UAC&amp;マルチユーザ対応案)</a>
    <span class="author">ryoji</span>
    <time datetime="2007-06-04T22:57:06">2007年06月04日 22:57</time></h1>
    <div class="body">▼ ryojiさん<br>&gt; 新規セットアップでは<br>&gt; ・OSに関係なくVirtual Store OFF用のsakura.exe.manifestを入れる<br>「OSに関係なく」は微妙かしら。Vistaだけにしたほうがいい？<br>移行前に流布しておきたいところだけど、Vistaにそのまま持っていったら設定が保存されなくなった！他のアプリは問題無いのに．．．となりそうな。</div></section>
    <ul><li><section><h1 id=4866>
    <span class="no">[4866]</span>
    <a class="thread-title" href="#4866">Re3:インストーラ作ってみました (Re7:UAC&amp;マルチユーザ対応案)</a>
    <span class="author">げんた</span>
    <time datetime="2007-06-04T23:12:55">2007年06月04日 23:12</time></h1>
    <div class="body">&gt;移行前に流布しておきたいところだけど、Vistaにそのまま持っていったら設定が保存されなくなった！他のアプリは問題無いのに．．．となりそうな。<br>XPからのアップグレードでVistaになるケースを考えると，最初の案のようにProgram Filesの配下だったらマルチユーザモードに切り替わるような機能が無いとうまく行かないのかなぁ．<br><br>旧バージョンをインストールしている場合→virtual storeで一見それっぽく動く<br>Vista対応版をインストールしている場合→急にアクセスできなくなる→マルチユーザ設定に自動的に移行<br><br>実にややこしい．<br><br>ところで，Windowsファイル保護ってCドライブ直下とかも保護対象(ただしVirutalStore適用外)だったように思いますが，XPからアップグレードした場合はどこまで保護対象になるかご存じですか．下手に本体だけVista対応しているとはまりそう．<br></div></section>
    <ul><li><section><h1 id=4867>
    <span class="no">[4867]</span>
    <a class="thread-title" href="#4867">Re4:インストーラ作ってみました (Re7:UAC&amp;マルチユーザ対応案)</a>
    <span class="author">ryoji</span>
    <time datetime="2007-06-04T23:42:20">2007年06月04日 23:42</time></h1>
    <div class="body">▼ げんたさん<br>&gt; ところで，Windowsファイル保護ってCドライブ直下とかも保護対象(ただしVirutalStore適用外)だったように思いますが，XPからアップグレードした場合はどこまで保護対象になるかご存じですか．<br>XPからのアップグレードでも同じみたいです。<br>Cドライブ直下への保存は仮想化有効アプリ／無効アプリのどっちでも拒否されます。</div></section>
    </li></ul></li></ul></li><li><section><h1 id=4864>
    <span class="no">[4864]</span>
    <a class="thread-title" href="#4864">Re2:インストーラ作ってみました (Re7:UAC&amp;マルチユーザ対応案)</a>
    <span class="author">げんた</span>
    <time datetime="2007-06-04T23:05:24">2007年06月04日 23:05</time></h1>
    <div class="body">&gt;既にsakura.exe.iniがあるなら<br>なるほど．インストール先に既に入っているファイルを確認して処理を分けたほうがいいですね．<br></div></section>
    </li></ul></li><li><section><h1 id=4865>
    <span class="no">[4865]</span>
    <a class="thread-title" href="#4865">設定移行ツール案</a>
    <span class="author">げんた</span>
    <time datetime="2007-06-04T23:05:24">2007年06月04日 23:05</time></h1>
    <div class="body">&gt;インストーラがAdministratorで動いているとVirtualStoreが見えない<br>VirtualStore無効設定へこんな感じで移行できるかもというシナリオを考えてみました．<br><br>sakura.exeにはmanifestを埋め込んでvirtual store無効にする．<br>manifestを埋め込まない移行ツール(互換モードで動作)を作成する．<br>マルチユーザかつsakura.iniが無い場合はvirtual storeにあるかもしれないsakura.iniを探すためにその移行ツールを起動．その際，実行ファイルのディレクトリと個人ディレクトリのパスを渡す．<br>移行ツールでは実行ファイルのディレクトリにあるかもしれないsakura.iniを開いてみる．もしopenに成功したら GetFinalPathNameByHandle()を呼びだして本当のパス名を取得する．<br>VirtualStoreなら ("VirtualStore"という文字列が含まれていればOK?) sakura.iniと同じディレクトリのファイルを全て個人ディレクトリへ移動(またはコピー)する．本当はsakura.iniの中身の書き換えをしないと辻褄が合わなくなるけどそこまで面倒を見られるかどうか．相対パスを活用すれば固定文字列の埋め込みで何とかなるか？<br>本体へ戻って，再度個人ディレクトリのsakura.iniをチェック．<br></div></section>
    </li><li><section><h1 id=4868>
    <span class="no">[4868]</span>
    <a class="thread-title" href="#4868">Re:インストーラ作ってみました (Re7:UAC&amp;マルチユーザ対応案)</a>
    <span class="author">ryoji</span>
    <time datetime="2007-06-08T01:21:30">2007年06月08日 01:21</time></h1>
    <div class="body">▼ げんたさん<br>&gt; とりあえずryojiさんのMultiUser2.patchを使ってマルチユーザ対応インストーラを作ってみました．<br>&gt; http://sakura.qp.land.to/dev/?Installer<br>sakura.exe単体ダウンロードのほうへは設定ファイルのサンプルとその説明ファイルを追加したらいいんじゃないかな～、と思い、説明ファイルに記載する文章を追加してみました。</div></section>
    </li></ul></li></ul></li></ul></li></ul></li></ul></li><li><section><h1 id=4846>
    <span class="no">[4846]</span>
    <a class="thread-title" href="#4846">Re3:UAC&amp;マルチユーザ対応案</a>
    <span class="author">ryoji</span>
    <time datetime="2007-05-24T00:00:29">2007年05月24日 00:00</time></h1>
    <div class="body">▼ げんたさん<br>&gt; &gt;CSIDL_APPDATAではなくCSIDL_PROFILE\.sakura\としてみたらどうだろう？<br>&gt; &gt;VistaだとC:\Users\&lt;username&gt;\が従来のマイドキュメント並の扱いになっていて、ここに入れると結構目立ちます。<br>&gt; いいかもしれませんね．XP以前では別にそれを使うのは必須ではないし，APPDATAでもProfile直下でも大差はないと思いますので．<br>ただ、MSの推奨はあくまでもCSIDL_APPDATA配下なので、手前勝手に作るのが良いとも言い切れず．．．<br>将来的にはCSIDL_APPDATAも可視になって「アプリケーション設定」などという別名で表示されるようになるかも。<br>推奨には従っておいて、エディタ本体にエディタの設定フォルダを開く機能を設けるほうが無難かもしれないです。<br><br>&gt; &gt;プレースバー<br>&gt; 余談ですが，先日PCショップに展示してあるMacを見て，プレースバーがあまりにVistaに似ていたので(というかVistaのバーがあまりにMacに似ていたので)驚きました．<br>人気の（？）Aero 3DフリップがMacのExpose（えくすぽぜ）の物真似という話も。</div></section>
    <ul><li><section><h1 id=4850>
    <span class="no">[4850]</span>
    <a class="thread-title" href="#4850">Re4:UAC&amp;マルチユーザ対応案</a>
    <span class="author">ryoji</span>
    <time datetime="2007-05-26T20:42:49">2007年05月26日 20:42</time></h1>
    <div class="body">&gt; &gt; &gt;CSIDL_APPDATAではなくCSIDL_PROFILE\.sakura\としてみたらどうだろう？<br>&gt; &gt; &gt;VistaだとC:\Users\&lt;username&gt;\が従来のマイドキュメント並の扱いになっていて、ここに入れると結構目立ちます。<br>&gt; &gt; いいかもしれませんね．XP以前では別にそれを使うのは必須ではないし，APPDATAでもProfile直下でも大差はないと思いますので．<br>&gt; ただ、MSの推奨はあくまでもCSIDL_APPDATA配下なので、手前勝手に作るのが良いとも言い切れず．．．<br>CSIDL_APPDATA配下のまま、設定画面の[OK]ボタンの左側の空き部分に[設定フォルダ]ボタンを追加してみました（→Patches）。<br>ボタンを押すとメニューが表示されます。<br>メニュー項目: [開く] 、[インポート／エクスポートの起点リセット]</div></section>
    </li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></body></html>